name: Claude Code Review

on:
    pull_request:
        types: [opened, synchronize]
        # Optional: Only run on specific file changes
        # paths:
        #   - "src/**/*.ts"
        #   - "src/**/*.tsx"
        #   - "src/**/*.js"
        #   - "src/**/*.jsx"

jobs:
    claude-review:
        # Optional: Filter by PR author
        # if: |
        #   github.event.pull_request.user.login == 'external-contributor' ||
        #   github.event.pull_request.user.login == 'new-developer' ||
        #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

        runs-on: ubuntu-latest
        permissions:
            contents: read
            pull-requests: write
            issues: read
            id-token: write
            actions: read # Required for Claude to read CI results

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 1

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.4"
                  extensions: mongodb
                  tools: composer:v2

            - name: Decode JWT keys
              run: |
                  mkdir -p config/jwt
                  echo "${{ secrets.JWT_PRIVATE_KEY }}" | base64 -d > config/jwt/private.pem
                  echo "${{ secrets.JWT_PUBLIC_KEY }}" | base64 -d > config/jwt/public.pem

            - name: Create .env file
              run: |
                  cat > .env << EOF
                  APP_ENV=test
                  APP_SECRET=${{ secrets.APP_SECRET }}
                  MONGODB_URL=${{ secrets.MONGODB_URL }}
                  MONGODB_DATABASE=${{ secrets.MONGODB_DATABASE }}
                  JWT_SECRET_KEY=%kernel.project_dir%/config/jwt/private.pem
                  JWT_PUBLIC_KEY=%kernel.project_dir%/config/jwt/public.pem
                  JWT_PASSPHRASE=${{ secrets.JWT_PASSPHRASE }}
                  DEFAULT_URI=http://localhost
                  CORS_ALLOW_ORIGIN='^https?://localhost(:[0-9]+)?$'
                  EOF
                  sed -i 's/^[[:space:]]*//' .env

            - name: Install dependencies
              run: composer install --prefer-dist --no-progress

            - name: Warm up cache for static analysis
              run: bin/console cache:warmup --env=dev

            - name: Run Claude Code Review
              id: claude-review
              uses: anthropics/claude-code-action@v1
              with:
                  claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  prompt: |
                      REPO: ${{ github.repository }}
                      PR NUMBER: ${{ github.event.pull_request.number }}

                      Please review this pull request thoroughly. Use the repository's CLAUDE.md for guidance on style and conventions.

                      ## Gather Context First

                      Before reviewing, determine if this is an initial review or a follow-up:

                      1. Run `gh pr view ${{ github.event.pull_request.number }} --comments` to see all previous comments on this PR
                      2. Run `gh pr view ${{ github.event.pull_request.number }} --json commits --jq '.commits[] | "\(.oid[0:7]) \(.messageHeadline)"'` to see the commit history

                      Check if there are any previous review comments from Claude (look for "Claude" in the author or comments that follow the review format below).

                      ## Review Process

                      ### If this is the FIRST review (no previous Claude comments):

                      1. Run static analysis tools:
                         - `composer test:types` (PHPStan)
                         - `composer test:arch` (Deptrac)
                         - `composer test:cs` (code style)

                      2. Use the `code-reviewer` agent to perform a comprehensive code review checking:
                         - Code quality and potential bugs
                         - Security vulnerabilities
                         - Missing functionality gaps
                         - Adherence to project coding standards

                      3. Use the `architecture-guardian` agent to validate:
                         - DDD/Hexagonal Architecture compliance
                         - CQRS pattern adherence
                         - Value object and aggregate design
                         - Layer boundary violations
                         - Event sourcing patterns

                      ### If this is a FOLLOW-UP review (previous Claude comments exist):

                      Do NOT use the code-reviewer or architecture-guardian agents. Instead:

                      1. Run static analysis tools to verify no new issues:
                         - `composer test:types` (PHPStan)
                         - `composer test:arch` (Deptrac)
                         - `composer test:cs` (code style)

                      2. Review the changes made since the last review:
                         - Identify which commits were added after the last Claude review
                         - Focus ONLY on the new/modified code in those commits
                         - Check if previous feedback was addressed correctly

                      3. Verify previously raised issues:
                         - Which issues from the previous review have been fixed?
                         - Are there any remaining unresolved issues?
                         - Did the fixes introduce any new problems?

                      ## Output

                      Compile your findings into a constructive review. Be specific about issues and provide actionable feedback.

                      If this is a follow-up review:
                      - Acknowledge which previous issues have been addressed
                      - Focus on any remaining or new issues
                      - Note if previous feedback was implemented correctly

                      Use `gh pr comment` with your Bash tool to post your review as a comment on the PR.

                  claude_args: |
                      --allowedTools "Bash(composer install:*),Bash(composer test:arch:*),Bash(composer test:behat:*),Bash(composer test:coverage:*),Bash(composer test:cs:*),Bash(composer test:e2e:*),Bash(composer test:integration:*),Bash(composer test:phpunit:*),Bash(composer test:types:*),Bash(composer test:unit:*),Bash(composer test:usecase:*),Bash(composer fix:cs:*),Bash(env:*),Bash(bin/console:*),Bash(vendor/bin/phpstan:*),Bash(vendor/bin/phpunit:*),Bash(vendor/bin/behat:*),Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"
