name: Claude Code

on:
    issue_comment:
        types: [created]
    pull_request_review_comment:
        types: [created]
    issues:
        types: [opened, assigned]
    pull_request_review:
        types: [submitted]

jobs:
    claude:
        if: |
            (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
            (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
            (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
            (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write
            issues: write
            id-token: write
            actions: read # Required for Claude to read CI results on PRs
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 1

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.4"
                  extensions: mongodb
                  tools: composer:v2

            - name: Decode JWT keys
              run: |
                  mkdir -p config/jwt
                  echo "${{ secrets.JWT_PRIVATE_KEY }}" | base64 -d > config/jwt/private.pem
                  echo "${{ secrets.JWT_PUBLIC_KEY }}" | base64 -d > config/jwt/public.pem

            - name: Create .env file
              run: |
                  cat > .env << EOF
                  APP_ENV=test
                  APP_SECRET=${{ secrets.APP_SECRET }}
                  MONGODB_URL=${{ secrets.MONGODB_URL }}
                  MONGODB_DATABASE=${{ secrets.MONGODB_DATABASE }}
                  JWT_SECRET_KEY=%kernel.project_dir%/config/jwt/private.pem
                  JWT_PUBLIC_KEY=%kernel.project_dir%/config/jwt/public.pem
                  JWT_PASSPHRASE=${{ secrets.JWT_PASSPHRASE }}
                  DEFAULT_URI=http://localhost
                  CORS_ALLOW_ORIGIN='^https?://localhost(:[0-9]+)?$'
                  EOF
                  sed -i 's/^[[:space:]]*//' .env

            - name: Install dependencies
              run: composer install --prefer-dist --no-progress

            - name: Run Claude Code
              id: claude
              uses: anthropics/claude-code-action@v1
              with:
                  claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  additional_permissions: |
                      actions: read
                  claude_args: |
                      --allowedTools "Bash(composer install:*),Bash(composer test:*),Bash(composer fix:cs:*),Bash(vendor/bin/phpstan:*),Bash(vendor/bin/behat:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr create:*),Bash(gh issue view:*),Bash(gh issue list:*),Bash(gh issue comment:*),Bash(gh issue create:*),Bash(git status:*),Bash(git log:*),Bash(git diff:*),Bash(git add:*),Bash(git commit:*),Bash(git push:*)"
